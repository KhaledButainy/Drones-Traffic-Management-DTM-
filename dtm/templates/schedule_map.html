{% extends "layout.html" %}
{% block content %}

<h1>Scheduling Map</h1>

<div class="container">
    <style type="text/css">
        .marker {
            background-image: '../static/drone-icon.png';
            background-size: cover;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }
        .coordinates {
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            position: absolute;
            bottom: 40px;
            left: 40px;
            padding: 5px 10px;
            margin: 0;
            font-size: 11px;
            line-height: 18px;
            border-radius: 3px;
            display: block;
        }
    </style>

    <div id='map' style='width: 100%; height: 500px;'></div>
    <pre id="coordinates" class="coordinates"></pre>
    <script>
    mapboxgl.accessToken = '{{mapbox_access_token}}';

    const coordinates = document.getElementById('coordinates');
    var map = new mapboxgl.Map({
      container: 'map',
      style: '{{mapbox_style}}',
    });

    map.on('load', () => {
        var geojson = {
            "type": "FeatureCollection",
            "features": []
        };
        var flight_start_dist = {
            "type": "FeatureCollection",
            'features' : []
        };

        map.addSource('geojson', {
            'type': 'geojson',
            'data': geojson
            });

        map.addSource('flight_start_dist', {
            'type': 'geojson',
            'data': flight_start_dist
            });
            
        // Add styles to the map
        map.addLayer({
            id: 'coordinate_points',
            type: 'circle',
            source: 'geojson',
            paint: {'circle-radius': 10,'circle-color': '#000'},
            filter: ['in', '$type', 'Point']
        });

        map.addLayer({
            id: 'src_dist_points',
            type: 'circle',
            source: 'flight_start_dist',
            paint: {'circle-radius': 7,'circle-color': '#000'},
            filter: ['in', '$type', 'Point']
        });

        // Change the cursor to a pointer when hovering over a point on the map.
        // Otherwise cursor is a crosshair.
        map.on('mousemove', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['coordinate_points', 'src_dist_points']
            });
            map.getCanvas().style.cursor = features.length
            ? 'pointer'
            : 'crosshair';

            if (flight_start_dist.features.length == 0){
                coordinates.innerHTML = `lng: ${e.lngLat.lng}, lat: ${e.lngLat.lat}`;
            } else if (flight_start_dist.features.length == 1){
                coordinates.innerHTML = `Start Point       | lng: ${flight_start_dist.features[0].geometry.coordinates[0]}, lat: ${flight_start_dist.features[0].geometry.coordinates[1]}<br />lng: ${e.lngLat.lng}, lat: ${e.lngLat.lat}`;
            } else if (flight_start_dist.features.length == 2){
                coordinates.innerHTML = `Start Point       | lng: ${flight_start_dist.features[0].geometry.coordinates[0]}, lat: ${flight_start_dist.features[0].geometry.coordinates[1]}<br />Distination Point | lng: ${flight_start_dist.features[1].geometry.coordinates[0]}, lat: ${flight_start_dist.features[1].geometry.coordinates[1]}<br />lng: ${e.lngLat.lng}, lat: ${e.lngLat.lat}`;
            }

        });
        
        map.on('click', (e) => {
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['src_dist_points']
            });
            if ('{{selected_drone}}' != 'None'){
                if (flight_start_dist.features.length == 0){
                    const point = {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [e.lngLat.lng, e.lngLat.lat]
                        },
                        'properties': {
                            'id': String(new Date().getTime()),
                            'src_dist' : 'Start'
                        }
                    }
                    flight_start_dist.features.push(point);
                    console.log(flight_start_dist.features);
                    document.getElementById('source_selected').style = "color:green";
                    document.getElementById('send_mission_btn').disabled = true;
                    coordinates.innerHTML = `Start Point       | lng: ${flight_start_dist.features[0].geometry.coordinates[0]}, lat: ${flight_start_dist.features[0].geometry.coordinates[1]}`;
                } else if (flight_start_dist.features.length == 1){
                    if (features.length){
                        const id = features[0].properties.id;
                        flight_start_dist.features = flight_start_dist.features.filter((point) => point.properties.id !== id);
                        document.getElementById('source_selected').style = "color:gray";
                        document.getElementById('distination_selected').style = "color:gray";
                        document.getElementById('send_mission_btn').disabled = true;
                    }else{
                        const point = {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [e.lngLat.lng, e.lngLat.lat]
                        },
                        'properties': {
                            'id': String(new Date().getTime()),
                            'src_dist' : 'Distination'
                        }
                    }
                    // here we should generate the flight path and plot it
                    flight_start_dist.features.push(point);
                    console.log(flight_start_dist.features);
                    document.getElementById('source_selected').style = "color:green";
                    document.getElementById('distination_selected').style = "color:green";
                    document.getElementById('send_mission_btn').disabled = false;
                    coordinates.innerHTML = `Start Point       | lng: ${flight_start_dist.features[0].geometry.coordinates[0]}, lat: ${flight_start_dist.features[0].geometry.coordinates[1]}<br />Distination Point | lng: ${flight_start_dist.features[1].geometry.coordinates[0]}, lat: ${flight_start_dist.features[1].geometry.coordinates[1]}`;
                    }                
                } else if (flight_start_dist.features.length == 2){
                    // here we should delete the flight path
                    flight_start_dist.features.shift();
                    flight_start_dist.features[0].properties.src_dist = 'Start'
                    console.log(flight_start_dist.features);
                    document.getElementById('source_selected').style = "color:green";
                    document.getElementById('distination_selected').style = "color:gray";
                    document.getElementById('send_mission_btn').disabled = true;
                    coordinates.innerHTML = `Start Point       | lng: ${flight_start_dist.features[0].geometry.coordinates[0]}, lat: ${flight_start_dist.features[0].geometry.coordinates[1]}`;
                }

                
                // updating the flight start and distination coordinates
                map.getSource('flight_start_dist').setData(flight_start_dist);
                
            };
        });
    })

    </script>
</div>

{% endblock content%}
{% block schedule_sidebar %}
<div class="col-md-4">
    <div class="content-section">
        <h3>Schedule a Flight</h3>
        &nbsp;
            <h6>Note: connect your drone kit first.</h6>
            &nbsp;
        &nbsp;
        <form class="form-inline" method="POST" action="{{ url_for('schedule_map_drone_select') }}">
            <h6 class="input-group-addon">Please select a drone</h6>
            <div class="form-group">
              <div class="input-group">
                <select name="drone_select" class="selectpicker form-control" required>
                    <option id="drone_option" name="drone_option" value="None" {% if selected_drone == 'None' %} selected {% endif %}>None</option>
                    {% for drone in drones %}
                        <option id="drone_option" name="drone_option" value="{{ drone.droneLicenseID }}" {% if selected_drone == drone.droneLicenseID %} selected {% endif %}>
                            {{ drone.type }}, {{ drone.brand }}, License: {{drone.droneLicenseID}}
                        </option>
                    {% endfor %}
                </select>
              </div>
              <button id="select_drone_btn" type="submit" class="btn btn-dark">Select</button>
            </div>
          </form>
    </div>
    <h5>Flight Required Info</h5>
    <body>
        <p style ="color:gray" id="drone_selected">- select <b>Drone</b></p>
        <script>
            if ("{{ selected_drone }}" == 'None'){
                document.getElementById("drone_selected").style = "color:gray"
            }else{
                document.getElementById("drone_selected").style = "color:green"
            }
        </script>
        <p style ="color:gray" id="source_selected">- select <b>Start Point</b></p>
        <p style ="color:gray" id="distination_selected">- select <b>Distination Point</b></p>
    </body>
        <button id="send_mission_btn" type="submit" class="btn btn-dark" {% if selected_drone == 'None' %} disabled = true {% else %} disabled = false {% endif %}>Send Mission to Drone</button>

</div>

<script>
    
</script>

{% endblock schedule_sidebar %}

